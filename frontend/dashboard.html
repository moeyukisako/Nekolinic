<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekolinic 诊所管理系统</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 顶部导航栏样式 */
        .navbar {
            background: rgba(57, 197, 187, 0.8); /* 80%不透明度的#39c5bb颜色 */
            color: white;
            padding: 1rem 1rem; /* 增加10px高度 */
            display: flex;
            justify-content: center; /* 居中对齐 */
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 70px; /* 明确设置高度 */
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .navbar-nav {
            position: absolute;
            right: 1rem;
            display: flex;
            align-items: center;
        }
        
        /* 用户菜单样式 */
        .user-menu {
            position: relative;
            margin-left: 1rem;
        }
        
        .user-menu-trigger {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        .user-menu-trigger:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: white;
            color: var(--color-bar-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            display: none;
            z-index: 101;
        }
        
        .user-menu-dropdown.active {
            display: block;
        }
        
        .user-menu-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .user-menu-name {
            font-weight: bold;
            color: #333;
        }
        
        .user-menu-role {
            color: #666;
            font-size: 0.9rem;
        }
        
        .user-menu-items {
            padding: 0.5rem 0;
        }
        
        .user-menu-item {
            padding: 0.75rem 1rem;
            color: #333;
            display: block;
            text-decoration: none;
            cursor: pointer;
        }
        
        .user-menu-item:hover {
            background-color: #f5f5f5;
        }
        
        /* 改进的侧边栏样式 */
        .sidebar {
            width: 64px; /* 默认收起状态更窄 */
            background-color: rgba(255, 255, 255, 0.1); /* 10%透明度的白色 */
            border-right: 1px solid #eee;
            height: calc(100vh - 60px);
            position: fixed;
            top: 60px;
            left: 0;
            overflow: hidden; /* 防止文本溢出 */
            z-index: 99;
            transition: all 0.3s ease;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }
        
        .sidebar:hover {
            width: 200px;
        }
        
        .sidebar-menu {
            padding: 1rem 0;
        }
        
        .sidebar-item {
            padding: 0.75rem 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            text-decoration: none;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }
        
        .sidebar-item i {
            font-size: 1.5rem;
            width: 32px;
            text-align: center;
            margin-right: 1rem;
        }
        
        .sidebar-item span {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .sidebar:hover .sidebar-item span {
            opacity: 1;
        }
        
        .sidebar-item:hover {
            background-color: rgba(255, 255, 255, 0.15); /* 稍微高一点的透明度 */
        }
        
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.2); /* 激活状态更高的透明度 */
            border-left: 3px solid var(--color-bar-primary);
            color: var(--color-bar-primary);
            font-weight: bold;
        }
        
        /* 改进后的内容区域 */
        .content {
            margin-left: 64px; /* 与侧边栏宽度对应 */
            padding: 1rem;
            padding-top: calc(70px + 35px); /* 顶部导航栏高度 + 35px间距 */
            min-height: calc(100vh - 60px);
            background-color: transparent; /* 完全透明背景 */
            transition: margin-left 0.3s ease;
        }
        
        .sidebar:hover + .content {
            margin-left: 200px;
        }
        
        /* 现代化搜索框样式 */
        .actions-bar {
            display: flex;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            margin-right: 1rem;
            display: flex;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #ddd;
            border-radius: 30px;
            background-color: white;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--color-bar-primary);
            box-shadow: 0 2px 8px rgba(57, 197, 187, 0.2);
        }
        
        .search-box i.fa-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .search-box .search-button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #777;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .search-box .search-button:hover {
            background-color: rgba(57, 197, 187, 0.1);
            color: var(--color-bar-primary);
        }
        
        /* 表格内操作按钮样式 */
        .action-link {
            color: #555;
            margin-right: 1rem;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }
        
        .action-link:hover {
            color: #999;
        }
        
        .action-link.delete {
            color: #8b0000; /* 深红色 */
        }
        
        .action-link.delete:hover {
            color: #c03;
        }
        
        /* 降低表格行高 */
        .data-table td, .data-table th {
            padding: 0.6rem 1rem;
        }
        
        /* 自定义模态框 */
        .modal-custom {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-custom.active {
            display: flex;
        }
        
        .modal-container {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            animation: modal-in 0.3s ease;
        }
        
        @keyframes modal-in {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .modal-body {
            margin-bottom: 1rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        /* 患者详情样式 */
        .patient-info {
            padding: 0.5rem 0;
        }
        
        .patient-info .info-row {
            display: flex;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .patient-info .info-label {
            width: 120px;
            font-weight: bold;
            text-align: right;
            padding-right: 1.5rem;
            color: #555;
        }
        
        .patient-info .info-value {
            flex: 1;
        }
        
        /* 没有匹配结果的提示样式 */
        .no-results {
            text-align: center;
            padding: 2rem;
            color: #777;
            font-style: italic;
        }
        
        /* 搜索结果提示样式 */
        .search-results-info {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            color: #555;
            font-style: italic;
            padding-left: 0.5rem;
        }
    </style>
</head>
<body class="dashboard">
    <!-- 背景图片容器 -->
    <div class="bg-container"></div>
    <div class="bg-overlay"></div>
    
    <!-- 顶部导航栏 -->
    <nav class="navbar">
        <div class="navbar-brand">Nekolinic.</div>
        <div class="navbar-nav">
            <div class="user-menu">
                <div class="user-menu-trigger" id="user-menu-trigger">
                    <div class="user-avatar-small" id="user-avatar">A</div>
                    <span id="user-name">加载中...</span>
                </div>
                <div class="user-menu-dropdown" id="user-menu-dropdown">
                    <div class="user-menu-header">
                        <div class="user-menu-name" id="dropdown-user-name">加载中...</div>
                        <div class="user-menu-role" id="dropdown-user-role">加载中...</div>
                    </div>
                    <div class="user-menu-items">
                        <a href="#" class="user-menu-item">个人信息</a>
                        <a href="#" class="user-menu-item">修改密码</a>
                        <a href="#" class="user-menu-item" id="logout-btn">退出登录</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <div class="main-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-menu sidebar-nav">
                <a href="#dashboard" class="sidebar-item active" data-section="dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>系统概览</span>
                </a>
                <a href="#patients" class="sidebar-item" data-section="patients">
                    <i class="fas fa-user-md"></i>
                    <span>患者管理</span>
                </a>
                <a href="#appointments" class="sidebar-item" data-section="appointments">
                    <i class="fas fa-calendar-check"></i>
                    <span>预约管理</span>
                </a>
                <a href="#medical-records" class="sidebar-item" data-section="medical-records">
                    <i class="fas fa-notes-medical"></i>
                    <span>病历管理</span>
                </a>
                <a href="#pharmacy" class="sidebar-item" data-section="pharmacy">
                    <i class="fas fa-capsules"></i>
                    <span>药房管理</span>
                </a>
                <a href="#finance" class="sidebar-item" data-section="finance">
                    <i class="fas fa-coins"></i>
                    <span>财务管理</span>
                </a>
                <a href="#reports" class="sidebar-item" data-section="reports">
                    <i class="fas fa-chart-pie"></i>
                    <span>报表分析</span>
                </a>
                <a href="#settings" class="sidebar-item" data-section="settings">
                    <i class="fas fa-sliders-h"></i>
                    <span>系统设置</span>
                </a>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="content main-content" id="content">
            <!-- 默认显示仪表盘 -->
            <div id="dashboard-section" class="content-section active">
                <h1>系统概览</h1>
                <p>欢迎使用 Nekolinic 诊所管理系统！</p>
                <div class="dashboard-cards">
                    <!-- 这里将来会显示统计卡片 -->
                </div>
            </div>
            
            <!-- 患者管理 -->
            <div id="patients-section" class="content-section" style="display: none;">
                <div id="patients-container">
                    <!-- 这里将由JavaScript动态加载患者管理界面 -->
                    <p>正在加载患者数据...</p>
                </div>
            </div>
            
            <!-- 其他内容区域，默认隐藏 -->
            <div id="appointments-section" class="content-section" style="display: none;">
                <h1>预约管理</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="medical-records-section" class="content-section" style="display: none;">
                <div id="medical-records-container">
                    <!-- 病历管理模块将由JavaScript动态渲染 -->
                </div>
            </div>
            
            <div id="pharmacy-section" class="content-section" style="display: none;">
                <h1>药房管理</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="finance-section" class="content-section" style="display: none;">
                <h1>财务管理</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="reports-section" class="content-section" style="display: none;">
                <h1>报表分析</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="settings-section" class="content-section" style="display: none;">
                <h1>系统设置</h1>
                <p>此功能正在开发中...</p>
            </div>
        </div>
    </div>

    <!-- 背景设置按钮 -->
    <div class="bg-settings">
        <button class="bg-settings-trigger" id="bg-settings-trigger">
            <i class="fas fa-image"></i>
        </button>
        <div class="bg-settings-panel" id="bg-settings-panel">
            <h4>背景设置</h4>
            <div class="bg-preview" id="bg-preview"></div>
            <div class="form-group">
                <label>本地图片</label>
                <div class="file-upload-container">
                    <label for="bg-file-input" class="file-upload-btn">
                        选择图片文件
                        <input type="file" id="bg-file-input" accept="image/*" style="display:none">
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>预设背景</label>
                <div class="local-backgrounds" id="local-backgrounds">
                    <div class="loading-backgrounds">加载中...</div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary btn-sm" id="reset-bg-btn">重置背景</button>
            </div>
        </div>
    </div>

    <!-- 通用通知模态框 -->
    <div class="modal-custom" id="notification-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">标题</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                内容将在这里显示
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel">取消</button>
                <button class="btn btn-primary" id="modal-confirm">确认</button>
            </div>
        </div>
    </div>

    <script src="js/apiClient.js"></script>
    <script src="js/app.js"></script>
    <script>
        // 检查是否已登录，未登录则重定向到首页
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            // 获取用户信息并更新用户菜单
            try {
                const user = await apiClient.auth.getCurrentUser();
                updateUserMenu(user);
            } catch (error) {
                console.error('获取用户信息失败', error);
                // 认证失效，返回首页
                localStorage.removeItem('accessToken');
                window.location.href = 'index.html';
            }
            
            // 绑定用户菜单事件
            const userMenuTrigger = document.getElementById('user-menu-trigger');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            
            userMenuTrigger.addEventListener('click', function() {
                userMenuDropdown.classList.toggle('active');
            });
            
            // 点击其他区域关闭下拉菜单
            document.addEventListener('click', function(event) {
                if (!event.target.closest('#user-menu-trigger') && 
                    !event.target.closest('#user-menu-dropdown')) {
                    userMenuDropdown.classList.remove('active');
                }
            });
            
            // 退出登录按钮点击事件
            document.getElementById('logout-btn').addEventListener('click', function() {
                apiClient.auth.logout();
            });
            
            // 侧边栏菜单切换
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const contentSections = document.querySelectorAll('.content-section');
            
            sidebarItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有激活状态
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    contentSections.forEach(s => s.style.display = 'none');
                    
                    // 激活当前项
                    this.classList.add('active');
                    const section = this.getAttribute('data-section');
                    document.getElementById(`${section}-section`).style.display = 'block';
                    
                    // 如果是患者管理部分，主动调用渲染函数
                    if (section === 'patients') {
                        console.log("加载患者管理模块");
                        const container = document.getElementById('patients-container');
                        if (container) {
                            container.innerHTML = '<p>正在加载患者数据...</p>';
                            renderPatientModule(container);
                        }
                    }
                });
            });
            
            // 设置模态框事件
            setupModalEvents();
            
            // 初始化背景设置
            initBackgroundSettings();
        });
        
        // 更新用户菜单
        function updateUserMenu(user) {
            // 使用用户名或全名，如果都不存在则使用默认值
            const userName = user.full_name || user.username || 'User';
            document.getElementById('user-name').textContent = userName;
            document.getElementById('dropdown-user-name').textContent = userName;
            document.getElementById('dropdown-user-role').textContent = user.role === 'admin' ? '系统管理员' : '普通用户';
            
            // 设置头像显示首字母
            const nameInitial = userName.charAt(0).toUpperCase();
            document.getElementById('user-avatar').textContent = nameInitial;
        }
        
        // 设置模态框事件
        function setupModalEvents() {
            const modal = document.getElementById('notification-modal');
            const closeBtn = document.getElementById('modal-close');
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmBtn = document.getElementById('modal-confirm');
            
            closeBtn.addEventListener('click', function() {
                modal.classList.remove('active');
            });
            
            cancelBtn.addEventListener('click', function() {
                modal.classList.remove('active');
            });
            
            // 默认确认按钮行为
            confirmBtn.addEventListener('click', function() {
                modal.classList.remove('active');
            });
        }
        
        // 显示通知模态框
        function showNotification(title, message, type) {
            const modal = document.getElementById('notification-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = message;
            modal.setAttribute('data-type', type);
            
            // 重置按钮事件为默认行为
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
            };
            
            // 根据类型配置按钮
            if (type === 'info') {
                confirmBtn.textContent = '确定';
                confirmBtn.style.display = '';
                cancelBtn.style.display = 'none';
            } else if (type === 'confirm') {
                confirmBtn.textContent = '确定';
                confirmBtn.style.display = '';
                cancelBtn.style.display = '';
            } else if (type === 'form') {
                confirmBtn.textContent = '保存';
                confirmBtn.style.display = '';
                cancelBtn.style.display = '';
            } else {
                confirmBtn.textContent = '确定';
                confirmBtn.style.display = '';
                cancelBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
        }
        
        // 初始化背景设置
        function initBackgroundSettings() {
            // 获取DOM元素
            const bgSettingsTrigger = document.getElementById('bg-settings-trigger');
            const bgSettingsPanel = document.getElementById('bg-settings-panel');
            const bgPreview = document.getElementById('bg-preview');
            const resetBgBtn = document.getElementById('reset-bg-btn');
            const fileInput = document.getElementById('bg-file-input');
            const localBackgrounds = document.getElementById('local-backgrounds');
            const bgContainer = document.querySelector('.bg-container');
            
            // 异步加载用户背景设置
            loadUserBackgroundSetting();
            
            // 背景设置面板切换
            if (bgSettingsTrigger) {
                bgSettingsTrigger.addEventListener('click', function() {
                    if (bgSettingsPanel) {
                        bgSettingsPanel.classList.toggle('active');
                    }
                });
            }
            
            // 点击其他区域关闭面板
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.bg-settings') && 
                    bgSettingsPanel && 
                    bgSettingsPanel.classList.contains('active')) {
                    bgSettingsPanel.classList.remove('active');
                }
            });
            
            // 处理文件上传事件
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const imageUrl = event.target.result;
                            
                            // 压缩图片
                            compressImage(imageUrl, function(compressedImageUrl) {
                                // 获取文件名
                                const fileName = `bg_${Date.now()}.jpg`;
                                
                                // 应用背景到UI以提供即时反馈
                                if (bgContainer) {
                                    bgContainer.style.backgroundImage = `url(${compressedImageUrl})`;
                                }
                                
                                // 更新预览
                                if (bgPreview) bgPreview.style.backgroundImage = `url(${compressedImageUrl})`;
                                
                                // 保存到服务器
                                try {
                                    // 将图片数据发送到服务器
                                    fetch(`${API_BASE_URL}/users/me/background-image`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                                        },
                                        body: JSON.stringify({
                                            image_data: compressedImageUrl,
                                            filename: fileName
                                        })
                                    })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error(`服务器响应错误: ${response.status}`);
                                        }
                                        return response.json();
                                    })
                                    .then(user => {
                                        // 更新全局用户对象
                                        currentUser = user;
                                        
                                        // 应用新的背景URL
                                        document.documentElement.style.setProperty('--bg-image', `url(${user.background_preference})`);
                                        
                                        // 清除所有缩略图激活状态
                                        const thumbnails = document.querySelectorAll('.bg-thumbnail');
                                        thumbnails.forEach(thumb => thumb.classList.remove('active'));
                                        
                                        // 从localStorage移除背景颜色设置
                                        document.documentElement.style.removeProperty('--bg-color');
                                        localStorage.removeItem('nekolinic-bg-color');
                                        
                                        showNotification('成功', '背景图片已成功应用并保存到您的帐户', 'info');
                                    })
                                    .catch(err => {
                                        showNotification('错误', '保存背景图片失败: ' + err.message, 'error');
                                        console.error('保存背景图片失败:', err);
                                    });
                                } catch (err) {
                                    showNotification('错误', '保存背景图片失败: ' + err.message, 'error');
                                    console.error('保存背景图片失败:', err);
                                }
                            });
                        };
                        
                        // 读取文件为DataURL
                        try {
                            reader.readAsDataURL(file);
                        } catch (err) {
                            showNotification('错误', '读取图片失败: ' + err.message, 'error');
                            console.error('读取图片文件失败:', err);
                        }
                    }
                });
            }
            
            // 重置背景
            if (resetBgBtn) {
                resetBgBtn.addEventListener('click', function() {
                    resetBackground();
                });
            }
            
            // 加载本地预设背景
            loadLocalBackgrounds();
            
            // 异步加载用户背景设置
            async function loadUserBackgroundSetting() {
                try {
                    // 获取当前用户信息
                    const user = await apiClient.auth.getCurrentUser();
                    
                    // 检查用户是否有保存的背景
                    if (user && user.background_preference) {
                        // 应用背景
                        const backgroundUrl = user.background_preference;
                        document.documentElement.style.setProperty('--bg-image', `url(${backgroundUrl})`);
                        if (bgContainer) {
                            bgContainer.style.backgroundImage = `url(${backgroundUrl})`;
                        }
                        if (bgPreview) bgPreview.style.backgroundImage = `url(${backgroundUrl})`;
                    } else {
                        // 检查是否有保存在localStorage的背景（向后兼容）
                        const savedBgImage = localStorage.getItem('nekolinic-bg-image');
                        if (savedBgImage) {
                            document.documentElement.style.setProperty('--bg-image', `url(${savedBgImage})`);
                            if (bgContainer) {
                                bgContainer.style.backgroundImage = `url(${savedBgImage})`;
                            }
                            if (bgPreview) bgPreview.style.backgroundImage = `url(${savedBgImage})`;
                            
                            // 将localStorage中的背景保存到用户账户中
                            try {
                                await apiClient.auth.updatePreferences({
                                    background_preference: savedBgImage
                                });
                                // 保存成功后清除localStorage
                                localStorage.removeItem('nekolinic-bg-image');
                            } catch (err) {
                                console.error('从localStorage迁移背景设置失败:', err);
                            }
                        }
                        
                        // 检查是否有保存的背景颜色
                        const savedBgColor = localStorage.getItem('nekolinic-bg-color');
                        if (savedBgColor) {
                            document.documentElement.style.setProperty('--bg-image', 'none');
                            document.documentElement.style.setProperty('--color-bg-primary', savedBgColor);
                            if (bgContainer) {
                                bgContainer.style.backgroundImage = 'none';
                            }
                            if (bgPreview) {
                                bgPreview.style.backgroundColor = savedBgColor;
                                bgPreview.style.backgroundImage = 'none';
                            }
                            
                            // 更新激活状态
                            const thumbnails = document.querySelectorAll('.bg-thumbnail');
                            thumbnails.forEach(thumb => {
                                if (thumb.getAttribute('data-color') === savedBgColor) {
                                    thumb.classList.add('active');
                                }
                            });
                            
                            // 将背景颜色保存到用户账户中
                            try {
                                await apiClient.auth.updatePreferences({
                                    background_preference: `color:${savedBgColor}`
                                });
                                // 保存成功后清除localStorage
                                localStorage.removeItem('nekolinic-bg-color');
                            } catch (err) {
                                console.error('从localStorage迁移背景颜色设置失败:', err);
                            }
                        }
                    }
                } catch (err) {
                    console.error('加载用户背景设置失败:', err);
                }
            }
            
            // 应用背景函数
            function applyBackground(imageUrl) {
                if (bgContainer) {
                    bgContainer.style.backgroundImage = `url(${imageUrl})`;
                }
                document.documentElement.style.setProperty('--bg-image', `url(${imageUrl})`);
                if (bgPreview) bgPreview.style.backgroundImage = `url(${imageUrl})`;
                
                // 保存到服务器
                apiClient.auth.updatePreferences({
                    background_preference: imageUrl
                }).then(() => {
                    // 更新所有缩略图激活状态
                    const thumbnails = document.querySelectorAll('.bg-thumbnail');
                    thumbnails.forEach(thumb => {
                        if (thumb.getAttribute('data-img') === imageUrl) {
                            thumb.classList.add('active');
                        } else {
                            thumb.classList.remove('active');
                        }
                    });
                    
                    showNotification('成功', '背景图片已成功应用并保存', 'info');
                }).catch(err => {
                    showNotification('错误', '保存背景设置失败: ' + err.message, 'error');
                    console.error('保存背景设置失败:', err);
                });
            }
            
            // 重置背景函数
            function resetBackground() {
                if (bgContainer) {
                    bgContainer.style.backgroundImage = 'none';
                }
                document.documentElement.style.setProperty('--bg-image', 'none');
                if (bgPreview) bgPreview.style.backgroundImage = 'none';
                
                // 清除所有缩略图激活状态
                const thumbnails = document.querySelectorAll('.bg-thumbnail');
                thumbnails.forEach(thumb => thumb.classList.remove('active'));
                
                // 清除文件输入
                if (fileInput) fileInput.value = '';
                
                // 保存到服务器
                apiClient.auth.updatePreferences({
                    background_preference: null
                }).then(() => {
                    showNotification('成功', '背景已重置', 'info');
                }).catch(err => {
                    showNotification('错误', '重置背景设置失败: ' + err.message, 'error');
                    console.error('重置背景设置失败:', err);
                });
            }
            
            // 加载本地预设背景
            function loadLocalBackgrounds() {
                if (!localBackgrounds) return;
                
                // 预设的本地背景路径
                const backgrounds = [
                    {name: '浅色背景', color: '#f5f5f5'},
                    {name: '深色背景', color: '#333333'},
                    {name: '蓝色背景', color: '#3498db'},
                    {name: '绿色背景', color: '#2ecc71'},
                    {name: '粉色背景', color: '#e91e63'}
                ];
                
                let html = '';
                
                backgrounds.forEach(bg => {
                    html += `
                        <div class="bg-thumbnail" 
                            style="background-color: ${bg.color}" 
                            data-color="${bg.color}"
                            title="${bg.name}">
                        </div>
                    `;
                });
                
                localBackgrounds.innerHTML = html || '<div class="no-backgrounds">暂无预设背景</div>';
                
                // 添加点击事件
                document.querySelectorAll('.bg-thumbnail').forEach(thumb => {
                    thumb.addEventListener('click', function() {
                        const color = this.getAttribute('data-color');
                        document.documentElement.style.setProperty('--bg-image', 'none');
                        document.documentElement.style.setProperty('--color-bg-primary', color);
                        if (bgContainer) bgContainer.style.backgroundImage = 'none';
                        if (bgPreview) bgPreview.style.backgroundColor = color;
                        if (bgPreview) bgPreview.style.backgroundImage = 'none';
                        
                        try {
                            // 保存颜色到服务器
                            apiClient.auth.updatePreferences({
                                background_preference: `color:${color}`
                            }).then(() => {
                                // 更新激活状态
                                document.querySelectorAll('.bg-thumbnail').forEach(t => t.classList.remove('active'));
                                this.classList.add('active');
                                
                                showNotification('成功', '背景颜色已成功应用并保存', 'info');
                            }).catch(err => {
                                showNotification('错误', '保存背景颜色失败: ' + err.message, 'error');
                                console.error('保存背景颜色失败:', err);
                            });
                        } catch (err) {
                            showNotification('错误', '保存背景颜色失败: ' + err.message, 'error');
                            console.error('保存背景颜色失败:', err);
                        }
                    });
                });
            }
            
            // 图片压缩函数
            function compressImage(dataUrl, callback, maxWidth = 8000, maxHeight = 6000, quality = 0.7) {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    
                    // 如果图片尺寸已经小于最大尺寸，直接返回
                    if (width <= maxWidth && height <= maxHeight && dataUrl.length < 5242880) {
                        callback(dataUrl);
                        return;
                    }
                    
                    // 计算新的尺寸，保持宽高比
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = Math.round(width * (maxHeight / height));
                        height = maxHeight;
                    }
                    
                    // 创建canvas绘制压缩后的图片
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 转换为DataURL
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    // 如果压缩后仍然过大，继续压缩
                    if (compressedDataUrl.length > 5242880) {
                        compressImage(compressedDataUrl, callback, maxWidth, maxHeight, quality * 0.8);
                    } else {
                        callback(compressedDataUrl);
                    }
                };
                img.onerror = function() {
                    callback(dataUrl); // 加载失败时使用原始数据
                };
                img.src = dataUrl;
            }
        }
    </script>
    
    <!-- 版权信息栏 -->
    <div class="copyright-bar">
        Nekolinic Version <span class="version-code">&lt;versioncode&gt;</span>, Copyright moeyukisako 2025.
    </div>
</body>
</html> 