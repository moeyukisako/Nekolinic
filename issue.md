# Nekolinic系统问题报告

## 患者管理模块问题总结

目前系统在患者管理功能上存在以下问题：

### 1. 患者API端点404错误

前端访问患者API（`/api/v1/patients`）时返回404错误。虽然服务器启动日志显示患者路由已正确注册（13个端点），但实际访问时返回"Not Found"。

**症状：**
- 前端请求`/api/v1/patients`返回404错误
- 患者列表显示"加载患者数据失败: 请求失败 (404)"
- API测试显示患者API端点无法访问

**可能原因：**
- 静态文件挂载可能覆盖了API路由
- API路由注册顺序问题
- 路径前缀配置不正确

### 2. 模型与数据库表不匹配

患者模型定义与实际数据库表结构不匹配。当尝试初始化测试数据时，系统报错"no such column: patients.phone"。

**症状：**
- 初始化患者数据失败，报错：`(sqlite3.OperationalError) no such column: patients.phone`
- 表结构查询显示数据库中的患者表没有phone字段，但模型中定义了该字段

**可能原因：**
- 数据库迁移未正确执行
- 模型定义更新后未更新数据库结构
- 数据库表结构与模型定义不同步

### 3. 循环导入问题

当尝试创建患者记录时，系统出现循环导入错误，无法解析Appointment依赖。

**症状：**
- 尝试创建Patient实例时报错：`KeyError: 'Appointment'`
- 报错信息：`When initializing mapper Mapper[Patient(patients)], expression 'Appointment' failed to locate a name ('Appointment')`

**可能原因：**
- 患者模型和预约模型之间存在循环依赖
- 模型关系定义时使用了字符串而非直接引用
- 导入顺序问题

## 解决方向

1. **检查并修复模型定义**：
   - 调整Patient模型，确保与数据库表结构匹配
   - 解决循环导入问题，使用延迟加载或字符串引用模型

2. **数据库同步**：
   - 创建新的迁移脚本，使数据库结构与当前模型匹配
   - 或修改模型以匹配现有数据库结构

3. **API路由问题**：
   - 确认API路由注册顺序，避免静态文件挂载覆盖API路由
   - 检查前端API调用配置，确保URL正确

4. **提供临时解决方案**：
   - 手动创建符合现有表结构的患者记录
   - 确保前端能够使用这些数据进行测试 