<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>欢迎使用 Nekolinic 诊所管理系统</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* 欢迎页特有样式 */
        .welcome-container {
            height: 100vh;
            display: flex;
            background-image: url('https://source.unsplash.com/random/1920x1080/?hospital,clinic');
            background-size: cover;
            background-position: center;
            position: relative;
            min-width: 320px; /* 设置最小宽度 */
            overflow-x: hidden; /* 防止在极小屏幕上出现水平滚动条 */
        }
        
        .welcome-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1;
        }
        
        .welcome-content {
            position: relative;
            z-index: 2;
            display: flex;
            width: 100%;
            padding: 0 1rem;
            justify-content: center; /* 居中对齐 */
            align-items: center; /* 确保垂直居中对齐 */
            min-height: 100%; /* 确保内容区域高度填满容器 */
        }
        
        .welcome-auth-container {
            width: 400px; /* 增加宽度 */
            display: flex;
            align-items: center;
            z-index: 3;
            padding: 0 15px;
        }
        
        /* 响应式调整 */
        @media (max-width: 500px) {
            .welcome-auth-container {
                width: 320px;
                padding: 0 10px;
            }
        }
        
        /* 登录表单样式 */
        .login-box {
            background: rgba(255, 255, 255, 0.35); /* 35%透明度的白色 */
            border-radius: 10px;
            padding: 3rem 2rem; /* 增加上下内边距 */
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: 100%;
            text-align: center;
        }
        
        .login-logo {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            color: var(--color-bar-primary);
            font-weight: bold;
            text-align: center;
        }
        
        .login-box h2 {
            margin-bottom: 2rem;
            text-align: center;
            color: #39c5bb; /* 修改为指定颜色 */
            font-size: 24px; /* 增大字体 */
        }
        
        /* 已登录用户信息样式 */
        .user-info {
            text-align: center;
            padding: 3rem 2rem; /* 增加上下内边距 */
            background: rgba(255, 255, 255, 0.35); /* 35%透明度的白色 */
            border-radius: 10px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .login-logo {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            color: var(--color-bar-primary);
            font-weight: bold;
        }
        
        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: var(--color-bar-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin: 0 auto 1.5rem auto;
        }
        
        .user-name {
            font-size: 1.5rem;
            margin-bottom: 2rem;
            color: white;
            word-wrap: break-word; /* 允许长用户名换行 */
        }
        
        .enter-btn {
            margin-top: 1rem;
            padding: 0.75rem 2rem;
            font-size: 1.2rem;
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: 80%;
            max-width: 240px;
        }
        
        /* 表单内容颜色 */
        .form-group label {
            color: white;
            font-weight: bold;
        }
        
        .welcome-auth-container input[type="text"],
        .welcome-auth-container input[type="password"] {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
        }
        
        .welcome-auth-container input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .text-danger {
            color: #ff6b6b !important;
            font-weight: bold;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
        
        .logout-link {
            display: block;
            margin-top: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            text-decoration: none;
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .logout-link:hover {
            color: white;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- 背景图片容器 -->
    <div class="bg-container"></div>
    <div class="bg-overlay"></div>
    
    <div class="welcome-container">
        <div class="welcome-content">
            <div class="welcome-auth-container" id="auth-container">
                <!-- 这里的内容将由JavaScript动态生成 -->
                <div class="loader" style="text-align: center; color: white;">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 背景设置按钮 -->
    <div class="bg-settings">
        <button class="bg-settings-trigger" id="bg-settings-trigger">
            <i class="fas fa-image"></i>
        </button>
        <div class="bg-settings-panel" id="bg-settings-panel">
            <h4>背景设置</h4>
            <div class="bg-preview" id="bg-preview"></div>
            <div class="form-group">
                <label>本地图片</label>
                <div class="file-upload-container">
                    <label for="bg-file-input" class="file-upload-btn">
                        选择图片文件
                        <input type="file" id="bg-file-input" accept="image/*" style="display:none">
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>预设背景</label>
                <div class="local-backgrounds" id="local-backgrounds">
                    <div class="loading-backgrounds">加载中...</div>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary btn-sm" id="reset-bg-btn">重置背景</button>
            </div>
        </div>
    </div>

    <!-- 版权信息栏 -->
    <div class="copyright-bar">
        Nekolinic Version <span class="version-code">&lt;versioncode&gt;</span>, Copyright moeyukisako 2025.
    </div>

    <script src="js/apiClient.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const authContainer = document.getElementById('auth-container');
            const token = localStorage.getItem('accessToken');
            
            if (token) {
                // 已登录，获取用户信息
                checkAuthAndRenderUserInfo(authContainer);
            } else {
                // 未登录，显示登录表单
                renderLoginForm(authContainer);
            }
            
            // 初始化背景设置
            initBackgroundSettings();
        });
        
        // 检查认证并渲染用户信息
        async function checkAuthAndRenderUserInfo(container) {
            try {
                const user = await apiClient.auth.getCurrentUser();
                renderUserInfo(container, user);
            } catch (error) {
                // 认证失效，显示登录表单
                localStorage.removeItem('accessToken');
                renderLoginForm(container);
            }
        }
        
        // 渲染用户信息
        function renderUserInfo(container, user) {
            // 使用用户名或全名，如果都不存在则使用默认值
            const userName = user.full_name || user.username || 'User';
            const nameInitial = userName.charAt(0).toUpperCase();
            
            container.innerHTML = `
                <div class="user-info">
                    <div class="login-logo">Nekolinic</div>
                    <div class="user-avatar">${nameInitial}</div>
                    <div class="user-name">欢迎回来，${userName}</div>
                    <button class="btn btn-primary enter-btn" onclick="enterSystem()">进入系统</button>
                    <a href="#" onclick="logout(); return false;" class="logout-link">退出登录</a>
                </div>
            `;
        }
        
        // 渲染登录表单
        function renderLoginForm(container) {
            container.innerHTML = `
                <div class="login-box">
                    <div class="login-logo">Nekolinic</div>
                    <h2>系统登录</h2>
                    <div id="login-error" class="text-danger" style="display: none; margin-bottom: 1rem; text-align: center;">
                        用户名或密码错误
                    </div>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="username">用户名</label>
                            <input type="text" id="username" name="username" required placeholder="请输入用户名 (测试账号: admin)">
                        </div>
                        <div class="form-group">
                            <label for="password">密码</label>
                            <input type="password" id="password" name="password" required placeholder="请输入密码 (测试密码: password)">
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">登录</button>
                    </form>
                </div>
            `;
            
            // 添加表单提交事件监听
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('login-error');
                
                try {
                    loginError.style.display = 'none';
                    await apiClient.auth.login(username, password);
                    // 登录成功，获取用户信息
                    checkAuthAndRenderUserInfo(container);
                } catch (error) {
                    // 显示错误信息
                    loginError.textContent = error.message || '用户名或密码错误';
                    loginError.style.display = 'block';
                }
            });
        }
        
        // 进入系统主界面
        function enterSystem() {
            window.location.href = 'dashboard.html';
        }
        
        // 退出登录
        function logout() {
            apiClient.auth.logout();
        }
        
        // 初始化背景设置
        function initBackgroundSettings() {
            // 获取DOM元素
            const bgSettingsTrigger = document.getElementById('bg-settings-trigger');
            const bgSettingsPanel = document.getElementById('bg-settings-panel');
            const bgPreview = document.getElementById('bg-preview');
            const resetBgBtn = document.getElementById('reset-bg-btn');
            const fileInput = document.getElementById('bg-file-input');
            const localBackgrounds = document.getElementById('local-backgrounds');
            const bgContainer = document.querySelector('.bg-container');
            
            // 从LocalStorage加载保存的背景
            const savedBgImage = localStorage.getItem('nekolinic-bg-image');
            if (savedBgImage) {
                document.documentElement.style.setProperty('--bg-image', `url(${savedBgImage})`);
                if (bgContainer) {
                    bgContainer.style.backgroundImage = `url(${savedBgImage})`;
                }
                if (bgPreview) bgPreview.style.backgroundImage = `url(${savedBgImage})`;
            }
            
            // 检查是否有保存的背景颜色
            const savedBgColor = localStorage.getItem('nekolinic-bg-color');
            if (savedBgColor) {
                document.documentElement.style.setProperty('--bg-image', 'none');
                document.documentElement.style.setProperty('--color-bg-primary', savedBgColor);
                if (bgContainer) {
                    bgContainer.style.backgroundImage = 'none';
                }
                if (bgPreview) {
                    bgPreview.style.backgroundColor = savedBgColor;
                    bgPreview.style.backgroundImage = 'none';
                }
                
                // 更新激活状态
                const thumbnails = document.querySelectorAll('.bg-thumbnail');
                thumbnails.forEach(thumb => {
                    if (thumb.getAttribute('data-color') === savedBgColor) {
                        thumb.classList.add('active');
                    }
                });
            }
            
            // 背景设置面板切换
            if (bgSettingsTrigger) {
                bgSettingsTrigger.addEventListener('click', function() {
                    if (bgSettingsPanel) {
                        bgSettingsPanel.classList.toggle('active');
                    }
                });
            }
            
            // 点击其他区域关闭面板
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.bg-settings') && 
                    bgSettingsPanel && 
                    bgSettingsPanel.classList.contains('active')) {
                    bgSettingsPanel.classList.remove('active');
                }
            });
            
            // 处理文件上传事件
            if (fileInput) {
                fileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const imageUrl = event.target.result;
                            
                            // 压缩图片
                            compressImage(imageUrl, function(compressedImageUrl) {
                                if (bgContainer) {
                                    bgContainer.style.backgroundImage = `url(${compressedImageUrl})`;
                                }
                                
                                // 更新预览
                                if (bgPreview) bgPreview.style.backgroundImage = `url(${compressedImageUrl})`;
                                
                                // 保存到localStorage
                                try {
                                    localStorage.setItem('nekolinic-bg-image', compressedImageUrl);
                                    document.documentElement.style.setProperty('--bg-image', `url(${compressedImageUrl})`);
                                    
                                    // 清除所有缩略图激活状态
                                    const thumbnails = document.querySelectorAll('.bg-thumbnail');
                                    thumbnails.forEach(thumb => thumb.classList.remove('active'));
                                    
                                    // 清除可能设置的背景颜色
                                    document.documentElement.style.removeProperty('--bg-color');
                                    localStorage.removeItem('nekolinic-bg-color');
                                    
                                    // 显示上传成功提示
                                    showNotification ? showNotification('成功', '背景图片已成功应用并保存', 'info') : alert('背景图片已成功应用并保存');
                                } catch (err) {
                                    showNotification ? showNotification('错误', '保存背景图片失败: ' + err.message, 'error') : alert('保存背景图片失败: ' + err.message);
                                    console.error('保存背景图片失败:', err);
                                }
                            });
                        };
                        
                        // 读取文件为DataURL
                        try {
                            reader.readAsDataURL(file);
                        } catch (err) {
                            showNotification ? showNotification('错误', '读取图片失败: ' + err.message, 'error') : alert('读取图片失败: ' + err.message);
                            console.error('读取图片文件失败:', err);
                        }
                    }
                });
            }
            
            // 重置背景
            if (resetBgBtn) {
                resetBgBtn.addEventListener('click', function() {
                    resetBackground();
                });
            }
            
            // 加载本地预设背景
            loadLocalBackgrounds();
            
            // 应用背景函数
            function applyBackground(imageUrl) {
                if (bgContainer) {
                    bgContainer.style.backgroundImage = `url(${imageUrl})`;
                }
                document.documentElement.style.setProperty('--bg-image', `url(${imageUrl})`);
                localStorage.setItem('nekolinic-bg-image', imageUrl);
                if (bgPreview) bgPreview.style.backgroundImage = `url(${imageUrl})`;
                
                // 更新所有缩略图激活状态
                const thumbnails = document.querySelectorAll('.bg-thumbnail');
                thumbnails.forEach(thumb => {
                    if (thumb.getAttribute('data-img') === imageUrl) {
                        thumb.classList.add('active');
                    } else {
                        thumb.classList.remove('active');
                    }
                });
            }
            
            // 重置背景函数
            function resetBackground() {
                if (bgContainer) {
                    bgContainer.style.backgroundImage = 'none';
                }
                document.documentElement.style.setProperty('--bg-image', 'none');
                localStorage.removeItem('nekolinic-bg-image');
                if (bgPreview) bgPreview.style.backgroundImage = 'none';
                
                // 清除所有缩略图激活状态
                const thumbnails = document.querySelectorAll('.bg-thumbnail');
                thumbnails.forEach(thumb => thumb.classList.remove('active'));
                
                // 清除文件输入
                if (fileInput) fileInput.value = '';
                
                alert('背景已重置');
            }
            
            // 加载本地预设背景
            function loadLocalBackgrounds() {
                if (!localBackgrounds) return;
                
                // 预设的本地背景路径
                const backgrounds = [
                    {name: '浅色背景', color: '#f5f5f5'},
                    {name: '深色背景', color: '#333333'},
                    {name: '蓝色背景', color: '#3498db'},
                    {name: '绿色背景', color: '#2ecc71'},
                    {name: '粉色背景', color: '#e91e63'}
                ];
                
                let html = '';
                const savedBgColor = localStorage.getItem('nekolinic-bg-color');
                
                backgrounds.forEach(bg => {
                    const isActive = savedBgColor === bg.color ? 'active' : '';
                    html += `
                        <div class="bg-thumbnail ${isActive}" 
                            style="background-color: ${bg.color}" 
                            data-color="${bg.color}"
                            title="${bg.name}">
                        </div>
                    `;
                });
                
                localBackgrounds.innerHTML = html || '<div class="no-backgrounds">暂无预设背景</div>';
                
                // 添加点击事件
                document.querySelectorAll('.bg-thumbnail').forEach(thumb => {
                    thumb.addEventListener('click', function() {
                        const color = this.getAttribute('data-color');
                        document.documentElement.style.setProperty('--bg-image', 'none');
                        document.documentElement.style.setProperty('--color-bg-primary', color);
                        if (bgContainer) bgContainer.style.backgroundImage = 'none';
                        if (bgPreview) bgPreview.style.backgroundColor = color;
                        if (bgPreview) bgPreview.style.backgroundImage = 'none';
                        
                        try {
                            localStorage.setItem('nekolinic-bg-color', color);
                            localStorage.removeItem('nekolinic-bg-image');
                            
                            // 更新激活状态
                            document.querySelectorAll('.bg-thumbnail').forEach(t => t.classList.remove('active'));
                            this.classList.add('active');
                            
                            alert('背景颜色已成功应用并保存');
                        } catch (err) {
                            alert('保存背景颜色失败: ' + err.message);
                            console.error('保存背景颜色失败:', err);
                        }
                    });
                });
            }
            
            // 图片压缩函数
            function compressImage(dataUrl, callback, maxWidth = 8000, maxHeight = 6000, quality = 0.7) {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;
                    
                    // 如果图片尺寸已经小于最大尺寸，直接返回
                    if (width <= maxWidth && height <= maxHeight && dataUrl.length < 5242880) {
                        callback(dataUrl);
                        return;
                    }
                    
                    // 计算新的尺寸，保持宽高比
                    if (width > maxWidth) {
                        height = Math.round(height * (maxWidth / width));
                        width = maxWidth;
                    }
                    
                    if (height > maxHeight) {
                        width = Math.round(width * (maxHeight / height));
                        height = maxHeight;
                    }
                    
                    // 创建canvas绘制压缩后的图片
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 转换为DataURL
                    const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                    
                    // 如果压缩后仍然过大，继续压缩
                    if (compressedDataUrl.length > 5242880) {
                        compressImage(compressedDataUrl, callback, maxWidth, maxHeight, quality * 0.8);
                    } else {
                        callback(compressedDataUrl);
                    }
                };
                img.onerror = function() {
                    callback(dataUrl); // 加载失败时使用原始数据
                };
                img.src = dataUrl;
            }
        }
    </script>
</body>
</html> 