<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nekolinic 诊所管理系统</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 顶部导航栏样式 */
        .navbar {
            background-color: var(--color-bar-primary);
            color: white;
            padding: 0.5rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .navbar-nav {
            display: flex;
            align-items: center;
        }
        
        /* 用户菜单样式 */
        .user-menu {
            position: relative;
            margin-left: 1rem;
        }
        
        .user-menu-trigger {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        .user-menu-trigger:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: white;
            color: var(--color-bar-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.5rem;
        }
        
        .user-menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            display: none;
            z-index: 101;
        }
        
        .user-menu-dropdown.active {
            display: block;
        }
        
        .user-menu-header {
            padding: 1rem;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .user-menu-name {
            font-weight: bold;
            color: #333;
        }
        
        .user-menu-role {
            color: #666;
            font-size: 0.9rem;
        }
        
        .user-menu-items {
            padding: 0.5rem 0;
        }
        
        .user-menu-item {
            padding: 0.75rem 1rem;
            color: #333;
            display: block;
            text-decoration: none;
            cursor: pointer;
        }
        
        .user-menu-item:hover {
            background-color: #f5f5f5;
        }
        
        /* 改进的侧边栏样式 */
        .sidebar {
            width: 64px; /* 默认收起状态更窄 */
            background-color: white;
            border-right: 1px solid #eee;
            height: calc(100vh - 60px);
            position: fixed;
            top: 60px;
            left: 0;
            overflow: hidden; /* 防止文本溢出 */
            z-index: 99;
            transition: all 0.3s ease;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        }
        
        .sidebar:hover {
            width: 200px;
        }
        
        .sidebar-menu {
            padding: 1rem 0;
        }
        
        .sidebar-item {
            padding: 0.75rem 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            text-decoration: none;
            cursor: pointer;
            white-space: nowrap;
            transition: background-color 0.2s ease;
        }
        
        .sidebar-item i {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            margin-right: 1rem;
        }
        
        .sidebar-item span {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .sidebar:hover .sidebar-item span {
            opacity: 1;
        }
        
        .sidebar-item:hover {
            background-color: #f5f5f5;
        }
        
        .sidebar-item.active {
            background-color: #f0f0f0;
            border-left: 3px solid var(--color-bar-primary);
            color: var(--color-bar-primary);
            font-weight: bold;
        }
        
        /* 改进后的内容区域 */
        .content {
            margin-left: 64px; /* 与侧边栏宽度对应 */
            padding: 1rem;
            min-height: calc(100vh - 60px);
            background-color: #f9f9f9;
            transition: margin-left 0.3s ease;
        }
        
        .sidebar:hover + .content {
            margin-left: 200px;
        }
        
        /* 现代化搜索框样式 */
        .actions-bar {
            display: flex;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            margin-right: 1rem;
            display: flex;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #ddd;
            border-radius: 30px;
            background-color: white;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--color-bar-primary);
            box-shadow: 0 2px 8px rgba(57, 197, 187, 0.2);
        }
        
        .search-box i.fa-search {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .search-box .search-button {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #777;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .search-box .search-button:hover {
            background-color: rgba(57, 197, 187, 0.1);
            color: var(--color-bar-primary);
        }
        
        /* 表格内操作按钮样式 */
        .action-link {
            color: #555;
            margin-right: 1rem;
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }
        
        .action-link:hover {
            color: #999;
        }
        
        .action-link.delete {
            color: #8b0000; /* 深红色 */
        }
        
        .action-link.delete:hover {
            color: #c03;
        }
        
        /* 降低表格行高 */
        .data-table td, .data-table th {
            padding: 0.6rem 1rem;
        }
        
        /* 自定义模态框 */
        .modal-custom {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-custom.active {
            display: flex;
        }
        
        .modal-container {
            background-color: white;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            animation: modal-in 0.3s ease;
        }
        
        @keyframes modal-in {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }
        
        .modal-body {
            margin-bottom: 1rem;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
        }
        
        /* 患者详情样式 */
        .patient-info {
            padding: 0.5rem 0;
        }
        
        .patient-info .info-row {
            display: flex;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }
        
        .patient-info .info-label {
            width: 120px;
            font-weight: bold;
            text-align: right;
            padding-right: 1.5rem;
            color: #555;
        }
        
        .patient-info .info-value {
            flex: 1;
        }
        
        /* 没有匹配结果的提示样式 */
        .no-results {
            text-align: center;
            padding: 2rem;
            color: #777;
            font-style: italic;
        }
        
        /* 搜索结果提示样式 */
        .search-results-info {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            color: #555;
            font-style: italic;
            padding-left: 0.5rem;
        }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <nav class="navbar">
        <div class="navbar-brand">Nekolinic 诊所管理系统</div>
        <div class="navbar-nav">
            <div class="user-menu">
                <div class="user-menu-trigger" id="user-menu-trigger">
                    <div class="user-avatar-small" id="user-avatar">A</div>
                    <span id="user-name">加载中...</span>
                </div>
                <div class="user-menu-dropdown" id="user-menu-dropdown">
                    <div class="user-menu-header">
                        <div class="user-menu-name" id="dropdown-user-name">加载中...</div>
                        <div class="user-menu-role" id="dropdown-user-role">加载中...</div>
                    </div>
                    <div class="user-menu-items">
                        <a href="#" class="user-menu-item">个人信息</a>
                        <a href="#" class="user-menu-item">修改密码</a>
                        <a href="#" class="user-menu-item" id="logout-btn">退出登录</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容区域 -->
    <div class="main-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="sidebar-menu">
                <a href="#dashboard" class="sidebar-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>系统概览</span>
                </a>
                <a href="#patients" class="sidebar-item" data-section="patients">
                    <i class="fas fa-user-injured"></i>
                    <span>患者管理</span>
                </a>
                <a href="#appointments" class="sidebar-item" data-section="appointments">
                    <i class="fas fa-calendar-alt"></i>
                    <span>预约管理</span>
                </a>
                <a href="#medical-records" class="sidebar-item" data-section="medical-records">
                    <i class="fas fa-file-medical"></i>
                    <span>病历管理</span>
                </a>
                <a href="#pharmacy" class="sidebar-item" data-section="pharmacy">
                    <i class="fas fa-pills"></i>
                    <span>药房管理</span>
                </a>
                <a href="#finance" class="sidebar-item" data-section="finance">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>财务管理</span>
                </a>
                <a href="#reports" class="sidebar-item" data-section="reports">
                    <i class="fas fa-chart-bar"></i>
                    <span>报表分析</span>
                </a>
                <a href="#settings" class="sidebar-item" data-section="settings">
                    <i class="fas fa-cog"></i>
                    <span>系统设置</span>
                </a>
            </div>
        </div>

        <!-- 内容区域 -->
        <div class="content" id="content">
            <!-- 默认显示仪表盘 -->
            <div id="dashboard-section" class="content-section active">
                <h1>系统概览</h1>
                <p>欢迎使用 Nekolinic 诊所管理系统！</p>
                <div class="dashboard-cards">
                    <!-- 这里将来会显示统计卡片 -->
                </div>
            </div>
            
            <!-- 患者管理 -->
            <div id="patients-section" class="content-section" style="display: none;">
                <h1>患者管理</h1>
                <div id="patients-container">
                    <!-- 这里将由JavaScript动态加载患者管理界面 -->
                    <p>正在加载患者数据...</p>
                </div>
            </div>
            
            <!-- 其他内容区域，默认隐藏 -->
            <div id="appointments-section" class="content-section" style="display: none;">
                <h1>预约管理</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="medical-records-section" class="content-section" style="display: none;">
                <h1>病历管理</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="pharmacy-section" class="content-section" style="display: none;">
                <h1>药房管理</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="finance-section" class="content-section" style="display: none;">
                <h1>财务管理</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="reports-section" class="content-section" style="display: none;">
                <h1>报表分析</h1>
                <p>此功能正在开发中...</p>
            </div>
            
            <div id="settings-section" class="content-section" style="display: none;">
                <h1>系统设置</h1>
                <p>此功能正在开发中...</p>
            </div>
        </div>
    </div>

    <!-- 自定义模态框 -->
    <div class="modal-custom" id="notification-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">标题</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                内容将在这里显示
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel">取消</button>
                <button class="btn btn-primary" id="modal-confirm">确认</button>
            </div>
        </div>
    </div>

    <!-- 患者详情模态框 -->
    <div class="modal-custom" id="patient-detail-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">患者详情</h3>
                <button class="modal-close" onclick="closePatientModal('patient-detail-modal')">&times;</button>
            </div>
            <div class="modal-body" id="patient-detail-content">
                <!-- 患者详情内容将在这里动态加载 -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closePatientModal('patient-detail-modal')">确定</button>
            </div>
        </div>
    </div>

    <!-- 患者编辑模态框 -->
    <div class="modal-custom" id="patient-edit-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title" id="edit-modal-title">编辑患者</h3>
                <button class="modal-close" onclick="closePatientModal('patient-edit-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="patient-edit-form">
                    <input type="hidden" id="edit-patient-id">
                    <div class="form-group">
                        <label for="edit-patient-name">姓名</label>
                        <input type="text" id="edit-patient-name" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-patient-gender">性别</label>
                        <select id="edit-patient-gender">
                            <option value="男">男</option>
                            <option value="女">女</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="edit-patient-age">年龄</label>
                        <input type="number" id="edit-patient-age" min="0" max="150">
                    </div>
                    <div class="form-group">
                        <label for="edit-patient-phone">电话</label>
                        <input type="tel" id="edit-patient-phone">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePatientModal('patient-edit-modal')">取消</button>
                <button class="btn btn-primary" onclick="savePatient()">保存</button>
            </div>
        </div>
    </div>

    <script src="js/apiClient.js"></script>
    <script>
        // 检查是否已登录，未登录则重定向到首页
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            // 获取用户信息并更新用户菜单
            try {
                const user = await apiClient.auth.getCurrentUser();
                updateUserMenu(user);
            } catch (error) {
                console.error('获取用户信息失败', error);
                // 认证失效，返回首页
                localStorage.removeItem('accessToken');
                window.location.href = 'index.html';
            }
            
            // 绑定用户菜单事件
            const userMenuTrigger = document.getElementById('user-menu-trigger');
            const userMenuDropdown = document.getElementById('user-menu-dropdown');
            
            userMenuTrigger.addEventListener('click', function() {
                userMenuDropdown.classList.toggle('active');
            });
            
            // 点击其他区域关闭下拉菜单
            document.addEventListener('click', function(event) {
                if (!event.target.closest('#user-menu-trigger') && 
                    !event.target.closest('#user-menu-dropdown')) {
                    userMenuDropdown.classList.remove('active');
                }
            });
            
            // 退出登录按钮点击事件
            document.getElementById('logout-btn').addEventListener('click', function() {
                apiClient.auth.logout();
            });
            
            // 侧边栏菜单切换
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            const contentSections = document.querySelectorAll('.content-section');
            
            sidebarItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有激活状态
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    contentSections.forEach(s => s.style.display = 'none');
                    
                    // 激活当前项
                    this.classList.add('active');
                    const section = this.getAttribute('data-section');
                    document.getElementById(`${section}-section`).style.display = 'block';
                    
                    // 如果是患者管理，加载患者数据
                    if (section === 'patients') {
                        loadPatients();
                    }
                });
            });
            
            // 设置模态框事件
            setupModalEvents();
            
            // 记录当前患者数据，用于搜索筛选
            let currentPatients = [];
            
            // 加载患者数据
            async function loadPatients() {
                const patientsContainer = document.getElementById('patients-container');
                
                try {
                    // 从API加载真实患者数据
                    currentPatients = await apiClient.patients.getAll();
                    
                    // 渲染患者列表
                    renderPatientsList(patientsContainer, currentPatients);
                } catch (error) {
                    patientsContainer.innerHTML = `
                        <div class="alert alert-danger">
                            加载患者数据失败: ${error.message || '未知错误'}
                        </div>
                    `;
                }
            }
            
            // 搜索患者
            function searchPatients(keyword) {
                const searchInput = document.getElementById('patient-search');
                const container = document.getElementById('patients-container');
                
                // 保留搜索框内容
                if (keyword !== searchInput.value) {
                    searchInput.value = keyword;
                }
                
                if (!keyword.trim()) {
                    // 如果搜索关键词为空，显示所有患者，不显示搜索提示
                    renderPatientsList(container, currentPatients);
                    return;
                }
                
                // 在现有数据中筛选匹配的患者
                const keyword_lower = keyword.toLowerCase().trim();
                const filteredPatients = currentPatients.filter(patient => 
                    patient.name.toLowerCase().includes(keyword_lower) || 
                    patient.phone.includes(keyword_lower) || 
                    patient.id.toString().includes(keyword_lower)
                );
                
                // 重新渲染筛选后的患者列表，并添加搜索结果提示
                renderPatientsList(container, filteredPatients, keyword);
            }
            
            // 渲染患者列表
            function renderPatientsList(container, patients, searchKeyword = null) {
                let html = `
                    <div class="actions-bar">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="patient-search" placeholder="搜索患者..." value="${searchKeyword || ''}">
                            <button class="search-button" id="search-button">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        <button class="btn btn-primary" id="add-patient-btn">添加患者</button>
                    </div>`;
                
                // 如果有搜索关键字，添加搜索结果提示
                if (searchKeyword) {
                    html += `
                    <div class="search-results-info">
                        以下是 "${searchKeyword}" 查找到的结果 (${patients.length}条)
                    </div>`;
                }
                
                html += `
                    <div class="card">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>姓名</th>
                                    <th>性别</th>
                                    <th>年龄</th>
                                    <th>联系电话</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                if (patients.length === 0) {
                    html += `
                        <tr>
                            <td colspan="6" class="no-results">未找到匹配的患者</td>
                        </tr>
                    `;
                } else {
                    patients.forEach(patient => {
                        html += `
                            <tr>
                                <td>${patient.id}</td>
                                <td>${patient.name}</td>
                                <td>${patient.gender}</td>
                                <td>${patient.age}</td>
                                <td>${patient.phone}</td>
                                <td>
                                    <a href="#" class="action-link view" data-id="${patient.id}">查看</a>
                                    <a href="#" class="action-link edit" data-id="${patient.id}">编辑</a>
                                    <a href="#" class="action-link delete" data-id="${patient.id}">删除</a>
                                </td>
                            </tr>
                        `;
                    });
                }
                
                html += `
                        </tbody>
                    </table>
                </div>
                `;
                
                container.innerHTML = html;
                
                // 添加事件监听器
                const searchInput = document.getElementById('patient-search');
                const searchButton = document.getElementById('search-button');
                
                // 搜索按钮点击事件
                searchButton.addEventListener('click', function() {
                    searchPatients(searchInput.value);
                });
                
                // 搜索框回车事件
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // 阻止表单提交
                        searchPatients(this.value);
                    }
                });
                
                document.getElementById('add-patient-btn').addEventListener('click', function() {
                    openAddPatientModal();
                });
                
                document.querySelectorAll('.action-link.view').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const id = this.getAttribute('data-id');
                        viewPatient(id);
                    });
                });
                
                document.querySelectorAll('.action-link.edit').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const id = this.getAttribute('data-id');
                        editPatient(id);
                    });
                });
                
                document.querySelectorAll('.action-link.delete').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const id = this.getAttribute('data-id');
                        confirmDeletePatient(id);
                    });
                });
            }
            
            // 查看患者详情
            function viewPatient(id) {
                // 根据ID查找患者数据
                const patient = getPatientById(id);
                
                if (!patient) {
                    showNotification('错误', `未找到ID为 ${id} 的患者`, 'info');
                    return;
                }
                
                // 构建患者详情HTML，使用表格式布局
                const detailHtml = `
                    <div class="patient-info">
                        <div class="info-row">
                            <div class="info-label">ID</div>
                            <div class="info-value">${patient.id}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">姓名</div>
                            <div class="info-value">${patient.name}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">性别</div>
                            <div class="info-value">${patient.gender}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">年龄</div>
                            <div class="info-value">${patient.age}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">电话</div>
                            <div class="info-value">${patient.phone}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">注册时间</div>
                            <div class="info-value">${new Date().toLocaleDateString()}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">最近就诊</div>
                            <div class="info-value">${new Date().toLocaleDateString()}</div>
                        </div>
                        <div class="info-row">
                            <div class="info-label">病历数量</div>
                            <div class="info-value">3</div>
                        </div>
                    </div>
                `;
                
                // 显示患者详情
                document.getElementById('patient-detail-content').innerHTML = detailHtml;
                
                // 获取模态框元素
                const modal = document.getElementById('patient-detail-modal');
                const closeBtn = modal.querySelector('.modal-close');
                const confirmBtn = modal.querySelector('.btn-primary');
                
                // 重新设置关闭按钮和确认按钮的事件处理程序
                closeBtn.onclick = function() {
                    modal.classList.remove('active');
                };
                
                confirmBtn.onclick = function() {
                    modal.classList.remove('active');
                };
                
                // 显示模态框
                modal.classList.add('active');
            }
            
            // 打开添加患者模态框
            function openAddPatientModal() {
                // 清空表单数据
                document.getElementById('edit-modal-title').textContent = '添加患者';
                document.getElementById('edit-patient-id').value = '';
                document.getElementById('edit-patient-name').value = '';
                document.getElementById('edit-patient-gender').value = '男';
                document.getElementById('edit-patient-age').value = '';
                document.getElementById('edit-patient-phone').value = '';
                
                // 显示模态框
                document.getElementById('patient-edit-modal').classList.add('active');
            }
            
            // 编辑患者信息
            function editPatient(id) {
                // 根据ID查找患者数据
                const patient = getPatientById(id);
                
                if (!patient) {
                    showNotification('错误', `未找到ID为 ${id} 的患者`, 'info');
                    return;
                }
                
                // 填充表单
                document.getElementById('edit-modal-title').textContent = '编辑患者';
                document.getElementById('edit-patient-id').value = patient.id;
                document.getElementById('edit-patient-name').value = patient.name;
                document.getElementById('edit-patient-gender').value = patient.gender;
                document.getElementById('edit-patient-age').value = patient.age;
                document.getElementById('edit-patient-phone').value = patient.phone;
                
                // 获取模态框和按钮
                const modal = document.getElementById('patient-edit-modal');
                const closeBtn = modal.querySelector('.modal-close');
                const cancelBtn = modal.querySelector('.btn-secondary');
                const saveBtn = modal.querySelector('.btn-primary');
                
                // 重新设置关闭和取消按钮事件
                closeBtn.onclick = function() {
                    modal.classList.remove('active');
                };
                
                cancelBtn.onclick = function() {
                    modal.classList.remove('active');
                };
                
                // 保存按钮事件
                saveBtn.onclick = function() {
                    savePatient();
                };
                
                // 显示模态框
                modal.classList.add('active');
            }
            
            // 保存患者信息
            async function savePatient() {
                const id = document.getElementById('edit-patient-id').value;
                const name = document.getElementById('edit-patient-name').value;
                const gender = document.getElementById('edit-patient-gender').value;
                const age = document.getElementById('edit-patient-age').value;
                const phone = document.getElementById('edit-patient-phone').value;
                
                if (!name) {
                    showNotification('提示', '请输入患者姓名', 'info');
                    return;
                }
                
                // 构建患者数据
                const patientData = {
                    name,
                    gender,
                    age: parseInt(age) || 0,
                    phone
                };
                
                try {
                    // 显示加载提示
                    document.getElementById('edit-patient-modal').querySelector('.btn-primary').disabled = true;
                    document.getElementById('edit-patient-modal').querySelector('.btn-primary').textContent = '保存中...';
                    
                    let response;
                    // 发送到API
                    if (id) {
                        // 编辑现有患者
                        response = await apiClient.patients.update(id, patientData);
                    } else {
                        // 添加新患者
                        response = await apiClient.patients.create(patientData);
                    }
                    
                    // 关闭模态框
                    closePatientModal('patient-edit-modal');
                    
                    // 显示成功消息
                    showNotification('成功', id ? '患者信息已成功更新' : '新患者已成功添加', 'info');
                    
                    // 重新加载患者列表
                    await loadPatients();
                    
                } catch (error) {
                    // 显示错误消息
                    showNotification('错误', error.message || '操作失败，请稍后重试', 'info');
                } finally {
                    // 恢复按钮状态
                    const saveBtn = document.getElementById('edit-patient-modal').querySelector('.btn-primary');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.textContent = '保存';
                    }
                }
            }
            
            // 确认删除患者
            function confirmDeletePatient(id) {
                // 根据ID查找患者数据
                const patient = getPatientById(id);
                
                if (!patient) {
                    showNotification('错误', `未找到ID为 ${id} 的患者`, 'info');
                    return;
                }
                
                const modal = document.getElementById('notification-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                const confirmBtn = document.getElementById('modal-confirm');
                const cancelBtn = document.getElementById('modal-cancel');
                
                modalTitle.textContent = '删除确认';
                modalBody.textContent = `确定要删除患者 ${patient.name} (ID: ${patient.id}) 吗？此操作不可撤销。`;
                modal.setAttribute('data-type', 'delete');
                modal.setAttribute('data-id', id);
                
                confirmBtn.textContent = '删除';
                confirmBtn.style.display = '';
                cancelBtn.style.display = '';
                
                // 设置确认按钮点击事件
                confirmBtn.onclick = function() {
                    deletePatient(id);
                };
                
                // 设置取消按钮点击事件
                cancelBtn.onclick = function() {
                    modal.classList.remove('active');
                };
                
                modal.classList.add('active');
            }
            
            // 删除患者
            async function deletePatient(id) {
                const modal = document.getElementById('notification-modal');
                
                try {
                    // 禁用按钮以防重复点击
                    const confirmBtn = document.getElementById('modal-confirm');
                    const cancelBtn = document.getElementById('modal-cancel');
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = '删除中...';
                    cancelBtn.disabled = true;
                    
                    // 调用API删除患者
                    await apiClient.patients.delete(id);
                    
                    // 关闭确认框
                    modal.classList.remove('active');
                    
                    // 显示成功消息
                    showNotification('成功', `患者已成功删除`, 'info');
                    
                    // 重新加载患者列表
                    await loadPatients();
                    
                } catch (error) {
                    // 关闭确认框
                    modal.classList.remove('active');
                    
                    // 显示错误消息
                    showNotification('错误', error.message || '删除失败，请稍后重试', 'info');
                } finally {
                    // 恢复按钮状态
                    const confirmBtn = document.getElementById('modal-confirm');
                    const cancelBtn = document.getElementById('modal-cancel');
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.textContent = '删除';
                    }
                    if (cancelBtn) {
                        cancelBtn.disabled = false;
                    }
                }
            }
            
            // 根据ID获取患者
            function getPatientById(id) {
                return currentPatients.find(p => p.id == id);
            }
            
            // 关闭患者相关模态框
            function closePatientModal(modalId) {
                document.getElementById(modalId).classList.remove('active');
            }
        });
        
        // 更新用户菜单
        function updateUserMenu(user) {
            // 使用用户名或全名，如果都不存在则使用默认值
            const userName = user.full_name || user.username || 'User';
            document.getElementById('user-name').textContent = userName;
            document.getElementById('dropdown-user-name').textContent = userName;
            document.getElementById('dropdown-user-role').textContent = user.role === 'admin' ? '系统管理员' : '普通用户';
            
            // 设置头像显示首字母
            const nameInitial = userName.charAt(0).toUpperCase();
            document.getElementById('user-avatar').textContent = nameInitial;
        }
        
        // 设置模态框事件
        function setupModalEvents() {
            const modal = document.getElementById('notification-modal');
            const closeBtn = document.getElementById('modal-close');
            const cancelBtn = document.getElementById('modal-cancel');
            const confirmBtn = document.getElementById('modal-confirm');
            
            closeBtn.addEventListener('click', function() {
                modal.classList.remove('active');
            });
            
            cancelBtn.addEventListener('click', function() {
                modal.classList.remove('active');
            });
            
            // 默认确认按钮行为
            confirmBtn.addEventListener('click', function() {
                modal.classList.remove('active');
            });
        }
        
        // 显示通知模态框
        function showNotification(title, message, type) {
            const modal = document.getElementById('notification-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');
            
            modalTitle.textContent = title;
            modalBody.textContent = message;
            modal.setAttribute('data-type', type);
            
            // 重置按钮事件为默认行为
            confirmBtn.onclick = function() {
                modal.classList.remove('active');
            };
            
            // 根据类型配置按钮
            if (type === 'info') {
                confirmBtn.textContent = '确定';
                confirmBtn.style.display = '';
                cancelBtn.style.display = 'none';
            } else if (type === 'confirm') {
                confirmBtn.textContent = '确定';
                confirmBtn.style.display = '';
                cancelBtn.style.display = '';
            } else if (type === 'form') {
                confirmBtn.textContent = '保存';
                confirmBtn.style.display = '';
                cancelBtn.style.display = '';
            } else {
                confirmBtn.textContent = '确定';
                confirmBtn.style.display = '';
                cancelBtn.style.display = 'none';
            }
            
            modal.classList.add('active');
        }
    </script>
</body>
</html> 